name: ğŸš€ Firebase ìë™ ë°°í¬

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
    
    # 2. Node.js ì„¤ì •
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./frontend
      run: npm ci
    
    # 4. í™˜ê²½ë³€ìˆ˜ ì£¼ì…í•˜ì—¬ ë¹Œë“œ (ì—¬ê¸°ê°€ í•µì‹¬!)
    - name: ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ (í™˜ê²½ë³€ìˆ˜ ì£¼ì…)
      working-directory: ./frontend
      run: npm run build
      env:
        # GitHub Secretsì—ì„œ í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        VITE_OPENAI_API_KEY: ${{ secrets.VITE_OPENAI_API_KEY }}
        VITE_KAKAO_API_KEY: ${{ secrets.VITE_KAKAO_API_KEY }}
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
    
    # 5. Firebaseì— ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
    - name: ğŸš€ Firebaseì— ë°°í¬
      if: github.ref == 'refs/heads/main'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        projectId: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        channelId: live
        entryPoint: ./frontend
      env:
        FIREBASE_CLI_EXPERIMENTS: webframeworks

    # 6. ë°°í¬ ê²°ê³¼ ì•Œë¦¼
    - name: âœ… ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸŒ ì‚¬ì´íŠ¸ URL: https://${{ secrets.VITE_FIREBASE_PROJECT_ID }}.web.app"
        
    - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼  
      if: failure()
      run: |
        echo "ğŸ’¥ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." 