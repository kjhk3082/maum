name: ğŸš€ Firebase ìë™ ë°°í¬

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
    
    # 2. Node.js ì„¤ì •
    - name: ğŸŸ¢ Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      working-directory: ./frontend
      run: npm ci
    
    # 4. í™˜ê²½ë³€ìˆ˜ ì£¼ì…í•˜ì—¬ ë¹Œë“œ (í˜„ì¬ ì‹œí¬ë¦¿ ì´ë¦„ ì‚¬ìš©)
    - name: ğŸ”¨ í”„ë¡œì íŠ¸ ë¹Œë“œ (í™˜ê²½ë³€ìˆ˜ ì£¼ì…)
      working-directory: ./frontend
      run: npm run build
      env:
        # í˜„ì¬ ì„¤ì •ëœ GitHub Secrets ì‚¬ìš©
        VITE_OPENAI_API_KEY: ${{ secrets.API2 }}
        VITE_KAKAO_API_KEY: "240138285eefbcd9ab66f4a85efbfbb5"
        # Firebase ì„¤ì • (FIREBASE ì‹œí¬ë¦¿ì—ì„œ ê°œë³„ ê°’ìœ¼ë¡œ ì¶”ì¶œ í•„ìš”)
        VITE_FIREBASE_API_KEY: "AIzaSyB9vHmOfRRe_deSWKMEIQEtDbXoUaDnJmQ"
        VITE_FIREBASE_AUTH_DOMAIN: "maumilgi-1a4cb.firebaseapp.com"
        VITE_FIREBASE_PROJECT_ID: "maumilgi-1a4cb"
        VITE_FIREBASE_STORAGE_BUCKET: "maumilgi-1a4cb.firebasestorage.app"
        VITE_FIREBASE_MESSAGING_SENDER_ID: "43173390015"
        VITE_FIREBASE_APP_ID: "1:43173390015:web:c93ba810fcb0972616880a"
        VITE_FIREBASE_MEASUREMENT_ID: "G-3KXTHTNKPC"
    
    # 5. Firebaseì— ë°°í¬ (main ë¸Œëœì¹˜ë§Œ) - í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
    - name: ğŸš€ Firebaseì— ë°°í¬
      if: github.ref == 'refs/heads/main'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASESECRET }}
        projectId: "maumilgi-1a4cb"
        channelId: live
        entryPoint: .
      env:
        FIREBASE_CLI_EXPERIMENTS: webframeworks

    # 6. ë°°í¬ ê²°ê³¼ ì•Œë¦¼
    - name: âœ… ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸŒ ì‚¬ì´íŠ¸ URL: https://maumilgi-1a4cb.web.app"
        
    - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼  
      if: failure()
      run: |
        echo "ğŸ’¥ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." 