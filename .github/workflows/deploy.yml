name: 🚀 Firebase 자동 배포

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 코드 체크아웃
    - name: 📥 코드 가져오기
      uses: actions/checkout@v4
    
    # 2. Node.js 설정
    - name: 🟢 Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    # 3. 의존성 설치
    - name: 📦 의존성 설치
      working-directory: ./frontend
      run: npm ci
    
    # 4. 환경변수 주입하여 빌드 (여기가 핵심!)
    - name: 🔨 프로젝트 빌드 (환경변수 주입)
      working-directory: ./frontend
      run: npm run build
      env:
        # GitHub Secrets에서 환경변수 가져오기
        VITE_OPENAI_API_KEY: ${{ secrets.VITE_OPENAI_API_KEY }}
        VITE_KAKAO_API_KEY: ${{ secrets.VITE_KAKAO_API_KEY }}
        VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
        VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
        VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
        VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
        VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
    
    # 5. Firebase에 배포 (main 브랜치만)
    - name: 🚀 Firebase에 배포
      if: github.ref == 'refs/heads/main'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        projectId: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
        channelId: live
        entryPoint: ./frontend
      env:
        FIREBASE_CLI_EXPERIMENTS: webframeworks

    # 6. 배포 결과 알림
    - name: ✅ 배포 완료 알림
      if: success()
      run: |
        echo "🎉 배포가 성공적으로 완료되었습니다!"
        echo "🌐 사이트 URL: https://${{ secrets.VITE_FIREBASE_PROJECT_ID }}.web.app"
        
    - name: ❌ 배포 실패 알림  
      if: failure()
      run: |
        echo "💥 배포가 실패했습니다. 로그를 확인해주세요." 