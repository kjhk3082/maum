name: 🚀 Firebase 자동 배포

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 코드 체크아웃
    - name: 📥 코드 가져오기
      uses: actions/checkout@v4
    
    # 2. Node.js 설정
    - name: 🟢 Node.js 설정
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    # 3. 의존성 설치
    - name: 📦 의존성 설치
      working-directory: ./frontend
      run: npm ci
    
    # 4. 환경변수 주입하여 빌드 (현재 시크릿 이름 사용)
    - name: 🔨 프로젝트 빌드 (환경변수 주입)
      working-directory: ./frontend
      run: npm run build
      env:
        # 현재 설정된 GitHub Secrets 사용
        VITE_OPENAI_API_KEY: ${{ secrets.API2 }}
        VITE_KAKAO_API_KEY: "240138285eefbcd9ab66f4a85efbfbb5"
        # Firebase 설정 (FIREBASE 시크릿에서 개별 값으로 추출 필요)
        VITE_FIREBASE_API_KEY: "AIzaSyB9vHmOfRRe_deSWKMEIQEtDbXoUaDnJmQ"
        VITE_FIREBASE_AUTH_DOMAIN: "maumilgi-1a4cb.firebaseapp.com"
        VITE_FIREBASE_PROJECT_ID: "maumilgi-1a4cb"
        VITE_FIREBASE_STORAGE_BUCKET: "maumilgi-1a4cb.firebasestorage.app"
        VITE_FIREBASE_MESSAGING_SENDER_ID: "43173390015"
        VITE_FIREBASE_APP_ID: "1:43173390015:web:c93ba810fcb0972616880a"
        VITE_FIREBASE_MEASUREMENT_ID: "G-3KXTHTNKPC"
    
    # 5. Firebase에 배포 (main 브랜치만) - 프로젝트 루트에서 실행
    - name: 🚀 Firebase에 배포
      if: github.ref == 'refs/heads/main'
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: ${{ secrets.GITHUB_TOKEN }}
        firebaseServiceAccount: ${{ secrets.FIREBASESECRET }}
        projectId: "maumilgi-1a4cb"
        channelId: live
        entryPoint: .
      env:
        FIREBASE_CLI_EXPERIMENTS: webframeworks

    # 6. 배포 결과 알림
    - name: ✅ 배포 완료 알림
      if: success()
      run: |
        echo "🎉 배포가 성공적으로 완료되었습니다!"
        echo "🌐 사이트 URL: https://maumilgi-1a4cb.web.app"
        
    - name: ❌ 배포 실패 알림  
      if: failure()
      run: |
        echo "💥 배포가 실패했습니다. 로그를 확인해주세요." 